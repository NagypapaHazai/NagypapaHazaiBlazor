@page "/login"
@using Microsoft.EntityFrameworkCore
@using NagypapaHazaiBlazor.MODELS
@using System.ComponentModel.DataAnnotations
@inject NagypapaContext Db
@inject NagypapaHazaiBlazor.Services.AuthState Auth
@inject NavigationManager Nav

<h3>Bejelentkezés</h3>

<EditForm Model="_model"
          OnValidSubmit="HandleLogin"
          FormName="login-form">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Email</label>
        <InputText @bind-Value="_model.Email" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Jelszó</label>
        <InputText @bind-Value="_model.Password" type="password" class="form-control" />
    </div>

    <button type="submit" class="btn btn-primary">Bejelentkezés</button>
</EditForm>

@if (!string.IsNullOrEmpty(_message))
{
    <p>@_message</p>
}

@code {
    private LoginModel _model = new();
    private string _message = "";

    public class LoginModel
    {
        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        public string Password { get; set; } = "";
    }

    private async Task HandleLogin()
    {
        var user = await Db.Users
            .FirstOrDefaultAsync(u => u.Email == _model.Email && u.PasswordHash == _model.Password);

        if (user == null)
        {
            _message = "Hibás email vagy jelszó.";
            Auth.SetUser(null);
            return;
        }

        Auth.SetUser(user);
        _message = "Sikeres bejelentkezés!";
        Nav.NavigateTo("/"); // vagy ahová szeretnéd
    }
}
