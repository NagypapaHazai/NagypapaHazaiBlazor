@page "/bookings/create"
@using Microsoft.EntityFrameworkCore
@using NagypapaHazaiBlazor.MODELS
@inject NagypapaContext Db
@inject NavigationManager Nav

<div class="container mx-auto px-4 py-8 max-w-lg">
    <h2 class="text-2xl font-bold mb-6 text-amber-800 flex items-center gap-2">
        <i class="fas fa-plus-circle"></i> Új foglalás
    </h2>

    @if (isLoading)
    {
        <div class="flex justify-center items-center h-48">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-600"></div>
        </div>
    }
    else
    {
        <EditForm Model="booking" OnValidSubmit="HandleValidSubmit" FormName="CreateBookingForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="mb-4 text-red-600 font-medium" />

            <div class="bg-white shadow-lg rounded-xl p-6 border border-gray-100">

                <!-- Név -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Vendég neve</label>
                    <InputText class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all"
                               placeholder="Írd be a nevet..."
                               @bind-Value="booking.UserName" />
                    <ValidationMessage For="@(() => booking.UserName)" class="text-red-500 text-xs mt-1" />
                </div>

                <!-- Ingatlan -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Válassz ingatlant</label>
                    <InputSelect class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all"
                                 @bind-Value="booking.PropertyId">
                        <option value="0">-- válassz --</option>
                        @foreach (var p in properties)
                        {
                            <option value="@p.Id">@p.Name</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => booking.PropertyId)" class="text-red-500 text-xs mt-1" />
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Kezdő dátum -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Érkezés</label>
                        <InputDate class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all"
                                   @bind-Value="booking.StartDate" />
                    </div>

                    <!-- Vég dátum -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Távozás</label>
                        <InputDate class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all"
                                   @bind-Value="booking.EndDate" />
                    </div>
                </div>

                <!-- Gombok -->
                <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100">
                    <a href="/bookings" class="text-gray-500 hover:text-gray-800 font-medium text-sm transition-colors">
                        Mégse
                    </a>
                    <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-all transform hover:-translate-y-0.5">
                        Mentés
                    </button>
                </div>

            </div>
        </EditForm>
    }
</div>

@code {
    [SupplyParameterFromForm]
    private NagypapaHazaiBlazor.MODELS.Booking booking { get; set; } = new();

    private List<NagypapaHazaiBlazor.MODELS.Property> properties = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // Ingatlanok betöltése a legördülőhöz
        properties = await Db.Properties.ToListAsync();

        // Alapértelmezett értékek beállítása
        if (booking.Id == 0) // Csak akkor, ha új
        {
            booking.Status = "pending";
            booking.StartDate = DateTime.Today;
            booking.EndDate = DateTime.Today.AddDays(1);
        }

        isLoading = false;
    }

    private async Task HandleValidSubmit()
    {
        // Mentés az adatbázisba
        Db.Bookings.Add(booking);
        await Db.SaveChangesAsync();

        // Visszairányítás a listához
        Nav.NavigateTo("/bookings");
    }
}
